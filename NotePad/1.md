# Android开发JetPack-Databinding组件

### 1. 什么是databinding

#### （1）简介

  Databinding是谷歌的一个官方支持库，它允许您使用声明性格式而不是通过编程方式将布局中的UI组件绑定到应用程序中的数据源。通常在活动中使用调用UI框架方法的代码来定义布局。例如，调用findViewById()以查找TextView窗口小部件并将其绑定到变量。因为它通过在布局文件中绑定组件，您可以删除活动中的许多UI框架调用，从而使它们更易于维护。这也可以提高应用程序的性能，并有助于防止内存泄漏和空指针异常。

#### （2）意义

  1、布局文件通常只负责UI控件的布局工作，页面中通过代码对控件需要进行各种操作，承担了绝大部分的工作量

  2、DataBinding让布局文件承担了部分原本属于页面的工作，也使得布局文件和页面的耦合度进一步降低

  3、使得UI控件能够直接合数据模型中的字段绑定，甚至能响应用户的交互。方便实现MVVM

### 2. databinding基本使用

#### （1）启用databinding
  
  在模块下的build.gradle文件中，启动dataBinding。
  
  ```java
  android {
    ...
    dataBinding {
        enabled = true
    }
  }
  ```
  
#### （2）先定义一个布局，显示用户的姓名，年龄和性别，将普通布局文件转换为DataBinding布局文件。

  转换后代码如下：
  
  ```xml
  <?xml version="1.0" encoding="utf-8"?>
  <layout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    xmlns:tools="http://schemas.android.com/tools">

    <data>

        <variable
            name="user"
            type="com.example.myapplication.domain.User" />
    </data>

    <androidx.constraintlayout.widget.ConstraintLayout
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        tools:context=".MainActivity">

        <androidx.constraintlayout.widget.Guideline
            android:id="@+id/guideline"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:orientation="horizontal"
            app:layout_constraintGuide_percent="0.10259918" />

        <androidx.constraintlayout.widget.Guideline
            android:id="@+id/guideline2"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:orientation="horizontal"
            app:layout_constraintGuide_percent="0.2" />

        <androidx.constraintlayout.widget.Guideline
            android:id="@+id/guideline3"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:orientation="horizontal"
            app:layout_constraintGuide_percent="0.3" />

        <androidx.constraintlayout.widget.Guideline
            android:id="@+id/guideline4"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:orientation="vertical"
            app:layout_constraintGuide_percent="0.3" />

        <TextView
            android:id="@+id/textView"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@string/text_name"
            app:layout_constraintBottom_toTopOf="@+id/guideline"
            app:layout_constraintEnd_toStartOf="@+id/guideline4"
            app:layout_constraintStart_toStartOf="parent"
            app:layout_constraintTop_toTopOf="parent" />

        <TextView
            android:id="@+id/textView2"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@string/text_age"
            app:layout_constraintBottom_toTopOf="@+id/guideline2"
            app:layout_constraintEnd_toStartOf="@+id/guideline4"
            app:layout_constraintStart_toStartOf="parent"
            app:layout_constraintTop_toTopOf="@+id/guideline" />

        <TextView
            android:id="@+id/textView3"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@string/text_gender"
            app:layout_constraintBottom_toTopOf="@+id/guideline3"
            app:layout_constraintEnd_toStartOf="@+id/guideline4"
            app:layout_constraintStart_toStartOf="parent"
            app:layout_constraintTop_toTopOf="@+id/guideline2" />

        <TextView
            android:id="@+id/textView4"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@{user.name}"
            app:layout_constraintBottom_toTopOf="@+id/guideline"
            app:layout_constraintEnd_toEndOf="parent"
            app:layout_constraintStart_toStartOf="@+id/guideline4"
            app:layout_constraintTop_toTopOf="parent" />

        <TextView
            android:id="@+id/textView6"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@{user.gender.toString()}"
            app:layout_constraintBottom_toTopOf="@+id/guideline3"
            app:layout_constraintEnd_toEndOf="parent"
            app:layout_constraintStart_toStartOf="@+id/guideline4"
            app:layout_constraintTop_toTopOf="@+id/guideline2" />

        <TextView
            android:id="@+id/textView7"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="@{String.valueOf(user.age)}"
            app:layout_constraintBottom_toTopOf="@+id/guideline2"
            app:layout_constraintEnd_toEndOf="parent"
            app:layout_constraintStart_toStartOf="@+id/guideline4"
            app:layout_constraintTop_toTopOf="@+id/guideline" />
    </androidx.constraintlayout.widget.ConstraintLayout>
   </layout>
   ```
   
 #### (3)创建一个User类，封装用户数据。
 
   ```java
   package com.sunofbeaches.databindingdemo.domain

   data class User(var name: String, var age: Int, var gender: Gender)

   enum class Gender {
       FEMALE, MALE
   }
   ```
   
 #### （4）改变MainActivity.kt的代码，拿到布局并给User赋值。
 
 ```java
   class MainActivity : AppCompatActivity() {

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        //如何获取到Binding,获取binding后可以给其中的变量赋值
        val binding:ActivityMainBinding = ActivityMainBinding.inflate(layoutInflater)
        //获取到View
        binding.user = User("LiMing", 30, Gender.Male)
        setContentView(binding.root)
   }
  }
  ```

- [![2.png](https://i.postimg.cc/Bv5fDV49/2.png)](https://postimg.cc/v1mKwX43)

### 3. 通过DatabindingUtil获取到Binding

（1）DataBindingUtil返回T，T是一个泛型，将其设为ActivityMainBinding，传参activity和Resource.id。
  
（2）ActivityMainBinding继承ViewDataBinding，返回binding。

（3）不需要设置ContentView，因为已经设置。

  代码：
  
  ```java
  class MainActivity : AppCompatActivity() {
   override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        //把布局交给DataBindingUtil
        val activityMainBinding: ActivityMainBinding =
            DataBindingUtil.setContentView(this, R.layout.activity_main)
        //设置数据
        activityMainBinding.user = User("LiMing", 20, Gender.MALE)
    }
  }
  ```
  
### 4.给BaseViewFragment加载View

创建一个base包，创建BaseViewFragment类继承Fragmen，创建方法返回View。

```java
  abstract class BaseViewFragment<T : ViewDataBinding> : Fragment() {

    protected var binding: T? = null

    override fun onCreateView(
        inflater: LayoutInflater,
        container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {
        binding = DataBindingUtil.inflate<T>(inflater, getSubLayoutId(), container, false)
        return binding!!.root
    }

    abstract fun getSubLayoutId() : Int
  }
  ```
  
### 5.编写BaseVmFragment

创建BaseVmFragment类。

```java
  abstract class BaseVmFragment<T : ViewDataBinding,VM:ViewModel> : BaseViewFragment<T>() {

    protected lateinit var viewModel: VM

    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)
        //创建ViewModel
        initViewModel()
        //观察数据变化--->更新UI
        abserverData()
        //设置相关的事件
        initEvent()
    }

    open fun initEvent(){
        
    }

    open fun abserverData(){

    }

    //创建ViewModel
    private fun initViewModel() {
        viewModel = ViewModelProvider(this).get(getSubVMClass())
    }

    abstract fun getSubVMClass(): Class<VM>
  }
  ```
  
### 6.布局和绑定表达式

- [![3.png](https://i.postimg.cc/RZ9bXfnf/3.png)](https://postimg.cc/1fCHz8B5)



